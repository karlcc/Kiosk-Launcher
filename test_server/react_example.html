<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>React.js Kiosk App Example</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            color: #1a202c;
        }

        .app {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .device-info {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .main {
            flex: 1;
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        .loading-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: #f8fafc;
        }

        .spinner {
            border: 4px solid #e2e8f0;
            border-left: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .auth-error {
            text-align: center;
            padding: 3rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            max-width: 500px;
            margin: 2rem auto;
        }

        .auth-error h1 {
            color: #e53e3e;
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .dashboard {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 2rem;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .status-card {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
        }

        .status-card h3 {
            color: #4a5568;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2d3748;
        }

        .notifications {
            margin-top: 2rem;
        }

        .notification {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid #667eea;
        }

        .notification.unread {
            background: #f0fff4;
            border-left-color: #38a169;
        }

        .notification.system {
            border-left-color: #3182ce;
        }

        .notification.security {
            border-left-color: #d69e2e;
        }

        .notification-content p {
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .notification-content small {
            color: #718096;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.2s;
        }

        button:hover {
            background: #5a67d8;
        }

        button:disabled {
            background: #a0aec0;
            cursor: not-allowed;
        }

        .error {
            background: #fed7d7;
            border: 1px solid #feb2b2;
            color: #c53030;
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
        }

        .security-info {
            background: #fffbeb;
            border: 1px solid #f6e05e;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 2rem;
        }

        .security-info h3 {
            color: #d69e2e;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // Authentication Hook
        const useAuth = () => {
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [deviceInfo, setDeviceInfo] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [debugInfo, setDebugInfo] = useState([]);

            useEffect(() => {
                checkInitialAuth();
            }, []);

            const checkInitialAuth = async () => {
                setIsLoading(true);
                const debugLog = [];
                
                const addDebug = (message, data = null) => {
                    const entry = { timestamp: new Date().toISOString(), message, data };
                    debugLog.push(entry);
                    setDebugInfo(prev => [...prev, entry]);
                    console.log(message, data || '');
                };

                try {
                    addDebug('üîê Starting device authentication flow...');
                    
                    // Step 1: Initial device authentication (gets signed by WebView)
                    console.log('üì± Step 1: Calling device_whitelist.php for initial authentication...');
                    const deviceResponse = await fetch('/device_whitelist.php', {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });

                    if (deviceResponse.ok) {
                        const deviceData = await deviceResponse.json();
                        console.log('‚úÖ Device authentication response:', deviceData);
                        
                        // Handle signed response structure - data is nested under 'data' property
                        const actualData = deviceData.data || deviceData;
                        console.log('üì¶ Extracted data:', actualData);
                        
                        if (actualData.access_granted && actualData.session_token) {
                            console.log('üé´ Step 2: Got session token, validating with api_validate.php...');
                            
                            // Step 2: Validate session token - use the session token from actualData
                            const validateResponse = await fetch('/api_validate.php', {
                                method: 'POST',
                                headers: { 
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${actualData.session_token}`
                                }
                            });

                            if (validateResponse.ok) {
                                const validateData = await validateResponse.json();
                                console.log('‚úÖ Session validation successful:', validateData);
                                console.log('üîç validateData.authenticated:', validateData.authenticated);
                                console.log('üîç Full validateData structure:', JSON.stringify(validateData, null, 2));
                                
                                if (validateData.authenticated === true) {
                                    addDebug('üéØ Setting isAuthenticated = true');
                                    
                                    const finalDeviceInfo = {
                                        device_id: actualData.device_id,
                                        device_name: actualData.device_name,
                                        device_location: actualData.device_location,
                                        expires_at: new Date(actualData.token_expires_at * 1000).toLocaleString(),
                                        ...validateData.device_info
                                    };
                                    
                                    addDebug('üè† Final deviceInfo:', finalDeviceInfo);
                                    
                                    // Use setTimeout to ensure state updates properly in WebView
                                    setTimeout(() => {
                                        addDebug('üè† Applying authentication state...');
                                        setIsAuthenticated(true);
                                        setDeviceInfo(finalDeviceInfo);
                                        addDebug('‚úÖ Authentication complete - should show dashboard now');
                                    }, 100);
                                    
                                    // Don't return early, let the flow complete
                                } else {
                                    console.log('‚ùå validateData.authenticated is not true:', validateData.authenticated);
                                }
                            } else {
                                console.log('‚ùå Session validation failed:', validateResponse.status);
                                const errorText = await validateResponse.text();
                                console.log('‚ùå Session validation error body:', errorText);
                            }
                        } else {
                            console.log('‚ùå Device authentication failed:', deviceData);
                            // Store failed device info for error display
                            if (actualData.device_id) {
                                setDeviceInfo({
                                    device_id: actualData.device_id,
                                    failed: true
                                });
                            }
                        }
                    } else {
                        console.log('‚ùå Device authentication response not OK:', deviceResponse.status);
                        // Try to get device ID from error response for display
                        try {
                            const errorData = await deviceResponse.json();
                            const errorActualData = errorData.data || errorData;
                            if (errorActualData.device_id) {
                                setDeviceInfo({
                                    device_id: errorActualData.device_id,
                                    failed: true
                                });
                            }
                        } catch (e) {
                            console.log('Could not parse error response');
                        }
                    }
                } catch (error) {
                    addDebug('üí• Auth check failed:', error.message);
                    console.error('üí• Auth check failed:', error);
                }
                
                addDebug('üèÅ Authentication flow completed, setIsLoading(false)');
                setIsLoading(false);
            };

            const logout = () => {
                setIsAuthenticated(false);
                setDeviceInfo(null);
                window.location.reload();
            };

            return { isAuthenticated, deviceInfo, isLoading, logout, checkInitialAuth, debugInfo };
        };

        // API Hook
        const useAPI = () => {
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);

            const apiCall = useCallback(async (endpoint, options = {}) => {
                setLoading(true);
                setError(null);

                try {
                    const response = await fetch(endpoint, {
                        ...options,
                        headers: {
                            'Content-Type': 'application/json',
                            ...options.headers
                        }
                    });

                    if (response.status === 401) {
                        throw new Error('Session expired. Please refresh the app.');
                    }

                    if (!response.ok) {
                        throw new Error(`API error: ${response.status}`);
                    }

                    return await response.json();

                } catch (err) {
                    setError(err.message);
                    throw err;
                } finally {
                    setLoading(false);
                }
            }, []);

            return { apiCall, loading, error };
        };

        // Loading Screen Component
        const LoadingScreen = ({ debugInfo = [] }) => (
            <div className="loading-screen">
                <div className="spinner"></div>
                <h2>üîê Authenticating Device...</h2>
                <p>Verifying cryptographic signatures and session tokens...</p>
                {debugInfo.length > 0 && (
                    <div style={{
                        marginTop: '20px',
                        padding: '15px',
                        background: '#1a202c',
                        color: '#e2e8f0',
                        borderRadius: '8px',
                        fontSize: '12px',
                        fontFamily: 'monospace',
                        maxHeight: '200px',
                        overflow: 'auto',
                        textAlign: 'left',
                        maxWidth: '600px'
                    }}>
                        <strong>Debug Log:</strong><br/>
                        {debugInfo.slice(-10).map((entry, index) => (
                            <div key={index} style={{marginBottom: '5px'}}>
                                <span style={{color: '#718096'}}>{entry.timestamp.split('T')[1].split('.')[0]}</span> {entry.message}
                                {entry.data && <pre style={{margin: '5px 0', fontSize: '11px'}}>{JSON.stringify(entry.data, null, 1)}</pre>}
                            </div>
                        ))}
                    </div>
                )}
            </div>
        );

        // Auth Error Component
        const AuthError = ({ deviceInfo }) => (
            <div className="loading-screen">
                <div className="auth-error">
                    <h1>üö´ Access Denied</h1>
                    <p>This device is not authorized to access this application.</p>
                    <p><strong>Device authentication failed.</strong></p>
                    {deviceInfo?.device_id && (
                        <div style={{background: '#f7fafc', padding: '15px', borderRadius: '6px', margin: '15px 0', fontFamily: 'monospace'}}>
                            <strong>Device ID:</strong> {deviceInfo.device_id}
                        </div>
                    )}
                    <p>Please contact your system administrator.</p>
                    <button onClick={() => window.location.reload()}>
                        üîÑ Retry Authentication
                    </button>
                </div>
            </div>
        );

        // Dashboard Component
        const Dashboard = () => {
            const [dashboardData, setDashboardData] = useState(null);
            const { apiCall, loading, error } = useAPI();

            useEffect(() => {
                loadDashboardData();
            }, []);

            const loadDashboardData = async () => {
                try {
                    const data = await apiCall('/api_data.php');
                    setDashboardData(data);
                } catch (error) {
                    console.error('Failed to load dashboard:', error);
                }
            };

            if (loading && !dashboardData) {
                return <div className="loading-screen"><div className="spinner"></div><p>Loading dashboard...</p></div>;
            }

            if (error && !dashboardData) {
                return (
                    <div className="error">
                        <p>‚ö†Ô∏è Error: {error}</p>
                        <button onClick={loadDashboardData}>üîÑ Retry</button>
                    </div>
                );
            }

            if (!dashboardData) {
                return <div>No data available</div>;
            }

            return (
                <div className="dashboard">
                    <div className="security-info">
                        <h3>üîê Security Status</h3>
                        <p>
                            <strong>‚úÖ Device Authenticated:</strong> {dashboardData.session_info?.device_name}<br/>
                            <strong>üìç Location:</strong> {dashboardData.session_info?.device_location}<br/>
                            <strong>üé´ Session Mode:</strong> {dashboardData.security_mode}<br/>
                            <strong>‚è∞ Session Expires In:</strong> {Math.round(dashboardData.session_info?.session_expires_in / 3600)} hours
                        </p>
                    </div>

                    <h2>üìä System Status</h2>
                    <div className="status-grid">
                        <div className="status-card">
                            <h3>Device Status</h3>
                            <p className="status-value">{dashboardData.data?.dashboard?.device_status || 'Online'}</p>
                        </div>
                        <div className="status-card">
                            <h3>Uptime</h3>
                            <p className="status-value">{dashboardData.data?.dashboard?.uptime || '24h 32m'}</p>
                        </div>
                        <div className="status-card">
                            <h3>Memory Usage</h3>
                            <p className="status-value">{dashboardData.data?.dashboard?.memory_usage || '65%'}</p>
                        </div>
                        <div className="status-card">
                            <h3>Storage</h3>
                            <p className="status-value">{dashboardData.data?.dashboard?.storage_available || '2.4 GB'}</p>
                        </div>
                    </div>

                    <h2>üîî Recent Notifications</h2>
                    <div className="notifications">
                        {dashboardData.data?.notifications?.map(notification => (
                            <div 
                                key={notification.id} 
                                className={`notification ${notification.type} ${notification.read ? 'read' : 'unread'}`}
                            >
                                <div className="notification-content">
                                    <p>{notification.message}</p>
                                    <small>{notification.timestamp}</small>
                                </div>
                            </div>
                        )) || (
                            <div className="notification system">
                                <div className="notification-content">
                                    <p>‚úÖ System authenticated successfully with hybrid cryptographic security</p>
                                    <small>{new Date().toLocaleString()}</small>
                                </div>
                            </div>
                        )}
                    </div>

                    <div style={{marginTop: '2rem', textAlign: 'center'}}>
                        <button onClick={loadDashboardData} disabled={loading}>
                            {loading ? 'üîÑ Refreshing...' : 'üîÑ Refresh Data'}
                        </button>
                    </div>
                </div>
            );
        };

        // Main App Component
        const App = () => {
            const { isAuthenticated, deviceInfo, isLoading, debugInfo } = useAuth();

            if (isLoading) {
                return <LoadingScreen debugInfo={debugInfo} />;
            }

            if (!isAuthenticated) {
                return <AuthError deviceInfo={deviceInfo} />;
            }

            return (
                <div className="app">
                    <header className="header">
                        <h1>üñ•Ô∏è Kiosk Dashboard</h1>
                        <div className="device-info">
                            üì± {deviceInfo?.device_name || 'Unknown Device'} ‚Ä¢ 
                            üìç {deviceInfo?.device_location || 'Unknown Location'} ‚Ä¢
                            ‚è∞ Session expires: {deviceInfo?.expires_at || 'Unknown'}
                        </div>
                    </header>
                    <main className="main">
                        <Dashboard />
                    </main>
                </div>
            );
        };

        // Render the app
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>